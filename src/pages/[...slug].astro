---
import LayoutPage from '../layouts/LayoutPage.astro';
import LayoutPost from '../layouts/LayoutPost.astro';
import fs from 'node:fs/promises';
import path from 'node:path';

// SSR Mode
export const prerender = false;

const { slug } = Astro.params;
// Handle root path or sanitize slug
const currentSlug = slug ? slug.replace(/^\/|\/$/g, '') : 'inicio'; 

const DATA_DIR = path.join(process.cwd(), 'src/data/wp');

// Helper to attempt reading a JSON file
async function findData(type: 'pages' | 'posts', slugName: string) {
    try {
        const filePath = path.join(DATA_DIR, type, `${slugName}.json`);
        // Check availability
        await fs.access(filePath);
        // Read file
        const raw = await fs.readFile(filePath, 'utf-8');
        return JSON.parse(raw);
    } catch {
        return null;
    }
}

// Strategy: Pages first, then Posts
let pageData = null;
let Layout = null;

// 1. Try Page
pageData = await findData('pages', currentSlug);
if (pageData) {
    Layout = LayoutPage;
} else {
    // 2. Try Post
    pageData = await findData('posts', currentSlug);
    if (pageData) {
        Layout = LayoutPost;
    }
}

// 404 or redirect
if (!pageData || !Layout) {
    return Astro.redirect('/404');
}
---

<Layout {...pageData}>
    {/* 
       Si el objeto JSON trae Content (HTML) ya renderizado por WP, lo inyectamos.
       Si trae bloques, iteramos.
       Por ahora asumimos que 'content' viene en el JSON.
    */}
    {pageData.data?.content && <Fragment set:html={pageData.data.content} />}
    
    {!pageData.data?.content && (
         <div class="container mx-auto py-12">
            <h1 class="text-3xl font-bold mb-4">{pageData.data?.title || pageData.title}</h1>
            <p>Contenido no disponible.</p>
         </div>
    )}
</Layout>
