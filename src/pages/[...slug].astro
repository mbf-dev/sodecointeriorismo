---
import Layout from '../layouts/Layout.astro';

// SSR Mode: Explicitly set prerender to false to avoid GetStaticPathsRequired error
export const prerender = false;

// We fetch data at runtime for every request.

const { slug } = Astro.params;
const currentPath = slug ? slug.replace(/^\/|\/$/g, '') : ''; // Sanitize current slug (empty string for homepage)

const WP_API_URL = 'https://sodeco.dev.net.pe/wp-json/mbf-sodeco/v1/structure';
let pageData = null;

try {
  const response = await fetch(WP_API_URL);
  if (response.ok) {
    const data = await response.json();
    
    // Normalized comparison helper
    const matchesSlug = (path: string) => {
        if (!path) return false;
        // WP path comes as /some-slug/, we treat it as some-slug
        // Homepage / matched to string ''
        const cleanPath = path.replace(/^\/|\/$/g, '');
        return cleanPath === currentPath;
    };

    // Search in Pages
    if (data.pages) {
        const found = data.pages.find((p: any) => matchesSlug(p.path));
        if (found) pageData = { type: 'page', ...found };
    }

    // Search in Posts (if not found yet)
    if (!pageData && data.posts) {
        const found = data.posts.find((p: any) => matchesSlug(p.path));
        if (found) pageData = { type: 'post', ...found };
    }

    // Search in Categories
    if (!pageData && data.categories) {
        const found = data.categories.find((c: any) => matchesSlug(c.path));
        if (found) pageData = { type: 'category', ...found };
    }

     // Search in Tags
    if (!pageData && data.tags) {
        const found = data.tags.find((t: any) => matchesSlug(t.path));
        if (found) pageData = { type: 'tag', ...found };
    }
  }
} catch (error) {
  console.error("Error fetching WP data:", error);
}

// 404 Handling: If no data found for this slug, return 404
if (!pageData) {
    return Astro.redirect('/404');
}

const { title, type, link, categories, tags } = pageData;
---
<!-- 
  Astro SSR Dynamic Route
  Fetches content mapping from WordPress at runtime.
-->

<Layout title={title || 'Sodeco'}>
    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold mb-4">{title}</h1>

        <div class="bg-gray-100 p-6 rounded-lg shadow-md">
            <p class="mb-2"><strong>Type:</strong> {type}</p>
            <p class="mb-2"><strong>Slug:</strong> {currentPath || '(Home)'}</p>
            <p class="mb-2"><strong>WP Link:</strong> <a href={link} target="_blank" class="text-blue-500 underline">{link}</a></p>
            
            {categories && categories.length > 0 && (
                <div class="mt-4">
                    <strong>Categories:</strong>
                    <ul class="list-disc pl-5">
                        {categories.map((cat: any) => (
                            <li>{cat.name} ({cat.slug})</li>
                        ))}
                    </ul>
                </div>
            )}

            {tags && tags.length > 0 && (
                <div class="mt-4">
                    <strong>Tags:</strong>
                    <ul class="list-disc pl-5">
                        {tags.map((tag: any) => (
                            <li>{tag.name} ({tag.slug})</li>
                        ))}
                    </ul>
                </div>
            )}
        </div>
        
        <div class="mt-8 text-sm text-gray-500">
            <p>Mode: SSR (Server Side Rendering). Data fetched at runtime.</p>
        </div>
    </div>
</Layout>
